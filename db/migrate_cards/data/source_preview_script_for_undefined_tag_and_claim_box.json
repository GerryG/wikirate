{
  "url": "http://dev.wikirate.org/export.json",
  "timestamp": "2014-11-06 19:09:50 +0100",
  "card": {
    "name": "export",
    "type": "Pointer",
    "content": "[[source preview page script]]",
    "value": [
      {
        "name": "source preview page script",
        "type": "JavaScript",
        "content": "var pageName = \"\";\r\nvar existingSource = false;\r\nvar companyName = \"\";\r\nvar topicName = \"\";\r\nvar markedIrrelevant = false;\r\nvar query_string = null;\r\n\r\nvar decodedCompanyName = null;\r\nvar decodedTopicName = null;\r\nvar decodeUrl = null;\r\n\r\n//===== helper functions\r\nvar entityMap = {\r\n  \"&\": \"&amp;\",\r\n  \"<\": \"&lt;\",\r\n  \">\": \"&gt;\",\r\n  '\"': '&quot;',\r\n  \"'\": '&#39;',\r\n  \"/\": '&#x2F;'\r\n};\r\nvar QueryString = function() {\r\n  // This function is anonymous, is executed immediately and \r\n  // the return value is assigned to QueryString!\r\n  if (!query_string)\r\n    query_string = {};\r\n  else\r\n    return query_string;\r\n  var query = window.location.search.substring(1);\r\n  var vars = query.split(\"&\");\r\n  for (var i = 0; i < vars.length; i++) {\r\n    var pair = vars[i].split(\"=\");\r\n    var key = pair[0].toLowerCase();;\r\n    var value = pair[1];\r\n    // If first entry with this name\r\n    if (typeof query_string[key] === \"undefined\") {\r\n      query_string[key] = value;\r\n      // If second entry with this name\r\n    } else if (typeof query_string[key] === \"string\") {\r\n      var arr = [query_string[key], value];\r\n      query_string[key] = arr;\r\n      // If third or later entry with this name\r\n    } else {\r\n      query_string[key].push(value);\r\n    }\r\n  }\r\n  return query_string;\r\n}();\r\nfunction escapeHtml(string) {\r\n  return String(string).replace(/[&<>\"'\\/]/g, function(s) {\r\n    return entityMap[s];\r\n  });\r\n}\r\n\r\nfunction unescapeHtml(string) {\r\n  return $(\"<div/>\").html(string).text();\r\n}\r\n\r\nfunction testSameOrigin(testUrl) {\r\n  $.getJSON(\"source%20preview%20page.json?view=check_iframable&url=\" + testUrl, function(data) {\r\n    if (!data.result) { //remove iframe and show redirection message\r\n      $('#webpage-preview').html(\"\");\r\n      $redirectNotice = $(\"<div>\", {\r\n        class: \"redirect-notice\"\r\n      });\r\n      $redirectNotice.append(\"This site blocks previews.<br/><a href='\" + decodeURIComponent(testUrl) + \"' target='_blank'>Visit original site</a><br /> <a href='#' id='noniframable-make-claim-button'>Make a claim</a>\");\r\n\r\n      $('#webpage-preview').append($redirectNotice);\r\n      $('#noniframable-make-claim-button').click(noniframableMakeClaimButtonClicked);\r\n    }\r\n  });\r\n\r\n}\r\n//=====show error msg in a new pop up window\r\nvar showErrorMsg = function(msg) {\r\n  $('#error-msg-field').html(msg);\r\n  $('#error-msg-field').dialog({\r\n    height: 'auto',\r\n    width: 'auto',\r\n\r\n    position: {\r\n      of: $(\"#logo-bar\"),\r\n      my: \"center top\",\r\n      at: \"center bottom\",\r\n      collision: \"none none\"\r\n    },\r\n    closeOnEscape: false,\r\n    resizable: false\r\n  });\r\n}\r\nvar noniframableMakeClaimButtonClicked = function() {\r\n  //create source\r\n  //direct to claim page\r\n  $('#loading_image_div').dialog({\r\n    height: 'auto',\r\n    width: 'auto',\r\n\r\n    position: {\r\n      of: $(\"#logo-bar\"),\r\n      my: \"center top\",\r\n      at: \"center bottom\",\r\n      collision: \"none none\"\r\n    },\r\n    closeOnEscape: false,\r\n    resizable: false\r\n  });\r\n  createSource(function(data) {\r\n      var pageNumer = data.match(/data-card-name=\"Page-(\\d+)\"/)[1];\r\n      window.location.href = \"/new/Claim?_Source=Page_\" + pageNumer;\r\n    },\r\n    function(xhr, ajaxOptions, thrownError) {\r\n      showErrorMsg(xhr.responseText);\r\n    });\r\n\r\n  //TODO: how to handle the fail case?!\r\n\r\n}\r\n\r\n\r\nfunction getSourceFirstCompany() {\r\n  var jqxhr = $.ajax(\"/\" + pageName + decodeURIComponent(\"+\") + \"company.json?item=name\")\r\n    .done(function(data) {\r\n      var $companyName = $('#company-and-topic').find('.company-name');\r\n      if (data.card.value.length > 0) {\r\n        //show this company name\r\n        if( typeof data.card.value[0] === \"string\")\r\n          companyName = data.card.value[0].split(\"[\")[0];\r\n        else{\r\n          companyName = data.card.value[0].name;    \r\n        }\r\n        \r\n        $companyName.html(\"<a href='\" + companyName + \"' target='_blank'><span class='company-name'>\" + decodeURIComponent(companyName) + \"</span></a>\");\r\n      } else {\r\n        //add \"add company and show detail company and topic\"\r\n        //show detail when click in existing source case\r\n        $companyName.addClass(\"no-content\");\r\n        $companyName.html(\"<a id='add-company-link' href='#' >Add Company</a>\");\r\n        $(\"#add-company-link\").click(comapnyAndTopicDetailLinkClicked);\r\n      }\r\n    })\r\n    .fail(function(xhr, ajaxOptions, thrownError) {\r\n      if (xhr.status == 404) {\r\n        $companyName.addClass(\"no-content\");\r\n        $companyName.html(\"<a id='add-company-link' href='#' >Add Company</a>\");\r\n        $(\"#add-company-link\").click(comapnyAndTopicDetailLinkClicked);\r\n\r\n      }else{\r\n        showErrorMsg(xhr.responseText);\r\n      }\r\n    });\r\n}\r\n\r\nfunction getSourceFirstTopic() {\r\n  var jqxhr = $.ajax(\"/\" + pageName + decodeURIComponent(\"+\") + \"topic.json?item=name\")\r\n    .done(function(data) {\r\n      var $topicName = $('#company-and-topic').find('.topic-name');\r\n      if (data.card.value.length > 0) {\r\n        if( typeof data.card.value[0] === \"string\")\r\n          topicName = data.card.value[0].split(\"[\")[0];\r\n        else{\r\n          topicName = data.card.value[0].name;    \r\n        }\r\n        //show this topic name\r\n        $topicName.html(\"<a href='\" + topicName + \"' target='_blank'><span class='topic-name'>\" + decodeURIComponent(topicName) + \"</span></a>\");\r\n      } else {\r\n        //add \"add company and show detail company and topic\"\r\n        //show detail when click in existing source case\r\n        $topicName.addClass(\"no-content\");\r\n        $topicName.html(\"<a id='add-topic-link' href='#' >Add Topic</a>\");\r\n        $(\"#add-topic-link\").click(comapnyAndTopicDetailLinkClicked);\r\n      }\r\n    })\r\n    .fail(function(xhr, ajaxOptions, thrownError) {\r\n      if (xhr.status == 404) {\r\n        $topicName.addClass(\"no-content\");\r\n        $topicName.html(\"<a id='add-topic-link' href='#' >Add Topic</a>\");\r\n        $(\"#add-topic-link\").click(comapnyAndTopicDetailLinkClicked);\r\n\r\n      }else{\r\n        showErrorMsg(xhr.responseText);\r\n      }\r\n    });\r\n}\r\n\r\nfunction enableMakeClaimButton() {\r\n  $(\"#make-a-claim-button\").removeAttr(\"disabled\");\r\n}\r\n\r\nfunction resizeIframe() {\r\n  $(\"#webpage-preview\").height($(window).height() - $('#logo-bar').height());\r\n}\r\n\r\nfunction showFromCerthSourceOptions() {\r\n\r\n  //new source, change the text \"make a claim\" to Relevant\r\n  //show irrelevant button\r\n  $(\"#make-a-claim-button\").html(\"Relevant\");\r\n  $(\"#mark-irrelevant\").show();\r\n  $(\"#make-claim\").show();\r\n}\r\nvar showExisitingSourceOptions = function() {\r\n\r\n  $(\"#source-page-link\").show();\r\n  $('#company-and-topic-detail-link').show();\r\n  $('#source-page-button').attr(\"href\", \"/\" + pageName);\r\n  $('#direct-link-button').attr(\"href\", decodeURIComponent(QueryString.url));\r\n  refreshClaimNumber(pageName);\r\n  $(\"#make-claim\").show();\r\n};\r\nvar reloadTopBarAsExisitingSource = function() {\r\n  //enable dropdown icon\r\n  //relevant to make a claim\r\n  //show direct link and source page link\r\n  //hide the irrelevant link\r\n  $(\"#mark-irrelevant\").hide();\r\n  $('#company-and-topic-detail-link').show();\r\n  $(\"#make-a-claim-button\").html(\"Make a claim\");\r\n  $('#source-page-button').attr(\"href\", \"/\" + pageName);\r\n  $('#direct-link-button').attr(\"href\", decodeURIComponent(QueryString.url));\r\n  $(\"#source-page-link\").show();\r\n  refreshClaimNumber(pageName);\r\n\r\n}\r\n\r\nfunction getSourcePageName(successfulCallback) {\r\n  var jqxhr = $.ajax(\"/source preview page.json?view=check_source&url=\" + QueryString.url)\r\n    .done(function(data) {\r\n      \r\n      if (data.source) {\r\n        pageName = data.source;\r\n        existingSource = true;\r\n        if (!QueryString.company)\r\n          getSourceFirstCompany();\r\n        if (!QueryString.topic)\r\n          getSourceFirstTopic();\r\n      }\r\n      if (successfulCallback)\r\n        successfulCallback();\r\n\r\n    })\r\n    .fail(function(xhr, ajaxOptions, thrownError) {\r\n      showErrorMsg(xhr.responseText);\r\n    });\r\n}\r\n\r\nfunction handleSourceHtmlAndNewClaimHtml(sourceHtml, newClaimFormHtml) {\r\n\r\n  \r\n  var _sourceHtml = $(sourceHtml);\r\n  _sourceHtml.find(\".remove-source\").remove();\r\n  var html = $(newClaimFormHtml);\r\n  html.find('.meta-side').remove();\r\n  html.find('.card-header').remove();\r\n\r\n  $('#claim-form').html(html);\r\n\r\n  $('#claim-form').find('form:first').find('.create-cancel-button:first').on('click', function() {\r\n    $('#claim-form').empty();\r\n    $('#claim-form').dialog(\"close\");\r\n  });\r\n  $(\"#claim-form\").prepend(_sourceHtml);\r\n  if (QueryString.fromcerth && QueryString.fromcerth == \"true\" && !existingSource)\r\n    $(\"#claim-form\").prepend(\"<span>Source added.</span>\");\r\n\r\n  //handle comapny and topic name \r\n  if (QueryString.company && $('.RIGHT-company select option[value=\"' + unescapeHtml(decodeURIComponent(QueryString.company)) + '\"]').length == 0) { //add company to select\r\n    $companySelect = $('.RIGHT-company select');\r\n    $companySelect.append('<option selected >' + decodeURIComponent(decodeURIComponent(QueryString.company)) + '</option>');\r\n    $companySelect.trigger(\"chosen:updated\");\r\n\r\n  }\r\n  if (QueryString.topic && $('.RIGHT-topic select option[value=\"' + unescapeHtml(decodeURIComponent(QueryString.topic)) + '\"]').length == 0) { //add company to select\r\n    $topicSelect = $('.RIGHT-topic select');\r\n    $topicSelect.append('<option selected >' + decodeURIComponent(decodeURIComponent(QueryString.topic)) + '</option>');\r\n    $topicSelect.trigger(\"chosen:updated\");\r\n  }\r\n  $('.tinymce-textarea').each(function() {\r\n    wagn.initTinyMCE($(this).attr('id'));\r\n  });\r\n  $('<input class=\"card-content\" id=\"card_subcards__Source_content\" name=\"card[subcards][+Source][content]\" value=\"' + pageName + '\" type=\"hidden\" />')\r\n    .insertAfter(\"#card_type_id\");\r\n  $('#claim-form').find('div:first').trigger('slotReady');\r\n  $('#claim-form').find('form:first').trigger('slotReady');\r\n}\r\nfunction refreshClaimNumber(pageName) {\r\n  var jqxhr = $.ajax(\"/\" + pageName + decodeURIComponent(\"+\") + \"claim count?view=core\")\r\n    .done(function(data) {\r\n      if (data > 0) {\r\n        $('#claim-count').html(\"<a class='show-link-in-popup' href='/\" +pageName + \"+source claim list' target='_blank'><span class='claim-count'>\" + data + \"</span><span class='claim-count'> Claims</span></a>\");\r\n        $('#claim-count').show();\r\n        $('.show-link-in-popup').each(function(){\r\n          $(this).off(\"click\").click(linkOnClick);\r\n        });\r\n      }\r\n    })\r\n    .fail(function(xhr, ajaxOptions, thrownError) {\r\n    });\r\n}\r\nfunction sendFeedback(type, successCallback, failcallback) {\r\n\r\n  var jqxhr = $.ajax(\"/source preview page.json?view=feedback&url=\" + QueryString.url + \"&company=\" + QueryString.company + \"&topic=\" + QueryString.topic + \"&type=\" + type)\r\n    .done(function(data) {\r\n      if (successCallback)\r\n        successCallback();\r\n    })\r\n    .fail(function(xhr, ajaxOptions, thrownError) {\r\n      console.log(\"Fail to send feedback\");\r\n      if (failcallback)\r\n        failcallback(xhr, ajaxOptions, thrownError);\r\n    });\r\n}\r\nvar showPermissionDenial = function(elementId) {\r\n  var jqxhr = $.ajax(\"/source preview page?view=denial\")\r\n    .done(function(data) {\r\n      //not possible i guess\r\n    })\r\n    .fail(function(xhr, ajaxOptions, thrownError) {\r\n      var $elementToShowPermissionDenial = $('#' + elementId);\r\n      $denialHtml = $(xhr.responseText);\r\n      $denialHtml.find('.card-header').remove();\r\n      $elementToShowPermissionDenial.html($denialHtml);\r\n\r\n    });\r\n}\r\nvar sendingIrrelevantFeedbackFailCallback = function(xhr, ajaxOptions, thrownError) {\r\n\r\n  if (xhr.responseText == \"Permission Denied\")\r\n    showPermissionDenial(\"after-irrelevant-options\");\r\n  else {\r\n    showErrorMsg(xhr.responseText);\r\n  }\r\n}\r\nvar afterSendingIrrelevantFeedback = function() {\r\n  $('#irrelevant-options').dialog(\"close\");\r\n  var $irrelevantButton = $('#mark-irrelevant-button');\r\n  $irrelevantButton.find(\"span:first\").html(\"Marked irrelevant\");\r\n  $irrelevantButton.replaceWith($irrelevantButton.html());\r\n  $('#mark-irrelevant').attr('disabled', 'disabled');\r\n  $('#mark-irrelevant').css(\"pointer-events\", \"none\");\r\n  $('#mark-irrelevant').css(\"cursor\", \"default\");\r\n  $('#make-claim').hide();\r\n\r\n\r\n  var $afterIrrelevantOption = $('#after-irrelevant-options');\r\n  var claimButtonHtml = $('#make-claim').html();\r\n  var $claimButton = $(claimButtonHtml);\r\n  $claimButton.html(\"Make a claim\");\r\n  $claimButton.attr(\"id\", \"make-claim-after-irrelevant\");\r\n  $afterIrrelevantOption.html($claimButton);\r\n  $claimButton = $('#make-claim-after-irrelevant');\r\n  $afterIrrelevantOption.append(\"<br /><span>Try other sources:</span><br />\");\r\n  $afterIrrelevantOption.append(\"<img id='loading_gif' src='{{loading_gif|source;size:medium;}}' />\");\r\n\r\n  $claimButton.click(function() {\r\n    makeClaimButtonOnClicked();\r\n    $('#after-irrelevant-options').dialog(\"close\");\r\n  });\r\n\r\n  //refer to suggested source script\r\n  addSuggestedSource($afterIrrelevantOption, $(\"#user-id\").html(), decodeURIComponent(QueryString.company), decodeURIComponent(QueryString.topic));\r\n\r\n}\r\n//=====checking if the combination of company and topic matched db's one\r\nvar checkCompanyAndTopicCombination = function(){\r\n  if (pageName == \"\") {\r\n    showFromCerthSourceOptions();\r\n  } else {\r\n    //get the company and topic \r\n    //check if the combination is the same\r\n    //yes show exisitingsourceoptions\r\n    //no show from certh\r\n    $.ajax(\"/\" + pageName + \"?slot[structure]=source_company_and_topic\")\r\n      .done(function(data) {\r\n        $sourceCT = $(data);\r\n        var $companySelectList = $($sourceCT.find(\".pointer-list\")[0]);\r\n        var companyMatched = false;\r\n        var topicMatched = false;\r\n        $companySelectList.find(\"a\").each(function() {\r\n          if (decodedCompanyName == $(this).html()) {\r\n            companyMatched = true;\r\n            return;\r\n          }\r\n        });\r\n        var $topicSelectList = $($sourceCT.find(\".pointer-list\")[1]);\r\n        $topicSelectList.find(\"a\").each(function() {\r\n          if (decodedTopicName == $(this).html()) {\r\n            topicMatched = true;\r\n            return;\r\n          }\r\n        });\r\n        if (topicMatched && companyMatched)\r\n          showExisitingSourceOptions();\r\n        else\r\n          showFromCerthSourceOptions();\r\n      })\r\n      .fail(companyAndTopicHtmlErrorGot);\r\n  }\r\n}\r\n\r\n\r\n//=====for irrelevant\r\nfunction prepareForAfterIrrelevantFeedback() {\r\n  $('#irrelevant-options').dialog(\"close\");\r\n\r\n  var $feedbackOptions = $('#after-irrelevant-options');\r\n  $feedbackOptions.html($('#loading_image_div').html());\r\n  $feedbackOptions.css('maxHeight', $(window).height() - $('#logo-bar').height());\r\n  $feedbackOptions.dialog({\r\n    height: 'auto',\r\n    width: '400',\r\n\r\n    position: {\r\n      of: $(\"#logo-bar\"),\r\n      my: \"right top\",\r\n      at: \"right bottom\",\r\n      collision: \"none none\"\r\n    },\r\n    title: '<i class=\"fa fa-arrows\"></i>',\r\n    closeOnEscape: false,\r\n    resizable: false\r\n  });\r\n}\r\nvar irrelevantClicked = function() {\r\n\r\n\r\n    //update the name of buttons\r\n    markedIrrelevant = true;\r\n    $('#company-irrelevant-button').html(decodeURIComponent(QueryString.company));\r\n    $('#topic-irrelevant-button').html(decodeURIComponent(QueryString.topic));\r\n    //bind the click events\r\n    $('#company-irrelevant-button').click(function() {\r\n      prepareForAfterIrrelevantFeedback();\r\n      sendFeedback(\"company\", afterSendingIrrelevantFeedback, sendingIrrelevantFeedbackFailCallback);\r\n\r\n    });\r\n    $('#topic-irrelevant-button').click(function() {\r\n      prepareForAfterIrrelevantFeedback();\r\n      sendFeedback(\"topic\", afterSendingIrrelevantFeedback, sendingIrrelevantFeedbackFailCallback);\r\n    });\r\n    $('#either-irrelevant-button').click(function() {\r\n      prepareForAfterIrrelevantFeedback();\r\n      sendFeedback(\"either\", afterSendingIrrelevantFeedback, sendingIrrelevantFeedbackFailCallback);\r\n    });\r\n\r\n\r\n\r\n    $('#irrelevant-options').dialog({\r\n      height: 'auto',\r\n      width: '300',\r\n      position: {\r\n        of: $(\"#logo-bar\"),\r\n        my: \"right top\",\r\n        at: \"right bottom\",\r\n        collision: \"none none\"\r\n      },\r\n      title: '<i class=\"fa fa-arrows\"></i>',\r\n      closeOnEscape: false,\r\n      resizable: false\r\n    });\r\n    return false;\r\n  }\r\n  //=====for company and topic detail\r\nvar comapnyAndTopicDetailLinkClicked = function() {\r\n  $('#company-and-topic-detail').html($('#loading_image_div').html());\r\n  $('#company-and-topic-detail').dialog({\r\n    height: 'auto',\r\n    minWidth: 500,\r\n    position: {\r\n      of: $(\"#company-and-topic\"),\r\n      my: \"center top\",\r\n      at: \"center bottom\",\r\n      collision: \"none none\"\r\n    },\r\n    title: '<i class=\"fa fa-arrows\"></i>',\r\n    closeOnEscape: false,\r\n    resizable: false\r\n  });\r\n  if (pageName != \"\") {\r\n    $.ajax(\"/\" + pageName + \"?slot[structure]=source_company_and_topic&view=edit\")\r\n      .done(companyAndTopicHtmlGot)\r\n      .fail(companyAndTopicHtmlErrorGot);\r\n\r\n  } else {\r\n    //show some msg?\r\n  }\r\n\r\n}\r\nvar companyAndTopicHtmlErrorGot = function(xhr, ajaxOptions, thrownError) {\r\n  var html = $(xhr.responseText);\r\n  html.find('.card-header').remove();\r\n  $('#company-and-topic-detail').html(html);\r\n\r\n  $(\"#\" + pageName.replace(\"-\", \"_\")).trigger('slotReady');\r\n}\r\nvar companyAndTopicHtmlGot = function(_html) {\r\n  var html = $(_html);\r\n  html.find('.card-header').remove();\r\n  $('#company-and-topic-detail').html(html);\r\n  $(\"#company-and-topic-detail\").find('.cancel-button:first').on('click', function() {\r\n\r\n    $('#company-and-topic-detail').empty();\r\n    $('#company-and-topic-detail').dialog(\"close\");\r\n\r\n  });\r\n\r\n  $(\"#company-and-topic-detail\").find('form:first').on('ajax:success', function(data, c, d) {\r\n    $('#company-and-topic-detail').empty();\r\n    refreshClaimNumber(pageName);\r\n    $('#company-and-topic-detail').dialog(\"close\");\r\n    return true;\r\n  });\r\n\r\n  $(\"#company-and-topic-detail\").find(\"#\" + pageName.replace(\"-\", \"_\")).trigger('slotReady');\r\n\r\n}\r\n\r\n//=====for claim ====\r\nvar makeClaimButtonOnClicked = function() {\r\n  if (!QueryString.url)\r\n    return false;\r\n\r\n  $makeClaimButton = $(this);\r\n  $makeClaimButton.attr(\"disabled\", \"disabled\");\r\n\r\n  //show loading dialog\r\n\r\n  $('#claim-form').html($('#loading_image_div').html());\r\n\r\n\r\n  $('#claim-form').dialog({\r\n    height: 'auto',\r\n    minWidth: 500,\r\n    position: {\r\n      of: $(\"#logo-bar\"),\r\n      my: \"right top\",\r\n      at: \"right bottom\",\r\n      collision: \"none none\"\r\n    },\r\n    title: '<i class=\"fa fa-arrows\"></i>',\r\n    closeOnEscape: false,\r\n    resizable: false\r\n  });\r\n\r\n  //create the source, get the html in source preview structure\r\n  sendFeedback(\"relevant\", function() {\r\n    createSource(sourceCreatedWithHtml, sourceCreatedFailCallback);\r\n\r\n  }, function(xhr, ajaxOptions, thrownError) {\r\n\r\n\r\n    if (xhr.responseText == \"Permission Denied\") {\r\n      showPermissionDenial(\"claim-form\");\r\n    } else {\r\n      //TODO: what to do for this?\r\n      showErrorMsg(xhr.responseText);\r\n    }\r\n    enableMakeClaimButton();\r\n  });\r\n\r\n}\r\nvar sourceCreatedFailCallback = function(xhr, ajaxOptions, thrownError) {\r\n  var html = $(xhr.responseText);\r\n  html.find('.card-header').remove();\r\n  $('#claim-form').html(html);\r\n  $('#claim-form').find('div:first').trigger('slotReady');\r\n  enableMakeClaimButton();\r\n}\r\n\r\nfunction createSource(callback, failCallback) {\r\n  var url = \"/card/create?\";\r\n  url += \"success[view]=content\";\r\n  url += \"&slot[structure]=source+preview\";\r\n  url += \"&sourcebox=true\";\r\n  url += \"&card[type_code]=webpage\"\r\n  url += \"&card[subcards][\" + encodeURIComponent(\"+\") + \"Link][content]=\" + QueryString.url\r\n  if (!markedIrrelevant) {\r\n    url += \"&card[subcards][\" + encodeURIComponent(\"+\") + \"Company][content]=\" + QueryString.company\r\n    url += \"&card[subcards][\" + encodeURIComponent(\"+\") + \"Topic][content]=\" + QueryString.topic\r\n  }\r\n  var jqxhr = $.ajax(url)\r\n    .done(callback)\r\n    .fail(function(xhr, ajaxOptions, thrownError) {\r\n      if (failCallback)\r\n        failCallback(xhr, ajaxOptions, thrownError);\r\n    });\r\n}\r\n\r\n\r\nvar sourceCreatedWithHtml = function(data) {\r\n  //get the claim form html\r\n\r\n  var sourceHtml = data;\r\n  $.ajax(\"/new/Claim?view=new&main=claim&is_main=true&slot%5Bhome_view%5D=open&slot%5Binc_name%5D=_main&slot%5Binc_syntax%5D=_main\" + (!markedIrrelevant ? (\"&_Companies=\" + QueryString.company + \"&_Topics=\" + QueryString.topic) : \"\"))\r\n    .done(function(claimFormHtml) {\r\n      gotNewClaimHtml(sourceHtml, claimFormHtml);\r\n    })\r\n    .fail(function(xhr, ajaxOptions, thrownError) {\r\n      var html = $(xhr.responseText);\r\n      html.find('.card-header').remove();\r\n      $('#claim-form').html(html);\r\n      $('#claim-form').find('div:first').trigger('slotReady');\r\n      enableMakeClaimButton();\r\n    });\r\n\r\n}\r\nvar gotNewClaimHtml = function(sourceHtml, newClaimFormHtml) {\r\n\r\n  //show the source and new claim form\r\n  //override the claim form buttons\r\n  //override the cancel button on click event to dismiss the dialogue only\r\n  var pageNumer = sourceHtml.match(/data-card-name=\"Page-(\\d+)\"/)[1];\r\n  pageName = \"Page-\" + pageNumer;\r\n  if (!markedIrrelevant)\r\n    reloadTopBarAsExisitingSource();\r\n  handleSourceHtmlAndNewClaimHtml(sourceHtml, newClaimFormHtml);\r\n  existingSource = true;\r\n  $('#claim-form').find('form:first').on('ajax:success', function(_event, data, xhr) {\r\n    if (!markedIrrelevant)\r\n      refreshClaimNumber(pageName);\r\n    //remove the claim\r\n    //show success\r\n    var $html = $(data);\r\n\r\n\r\n    $('.card-slot.new-view.card-frame.ALL.TYPE-claim:first').remove();\r\n    var $claimSuccess = $(\"<div id='claim-success'></div>\");\r\n    $claimSuccess.append(\"<span>Success! Thanks for making a claim.</span>\");\r\n    $claimSuccess.append(\"<a target='_blank' href='\" + $html.find(\"a:first\").attr('href').replace(\"?view=closed\", \"\") + \"'>Visit the claim.</a>\")\r\n    $claimSuccess.append(\"<a id='keep-reading' href='#'>Keep Reading.</a>\")\r\n    $('#claim-form').append($claimSuccess);\r\n\r\n    $('#keep-reading').click(function() {\r\n      $('#claim-form').dialog(\"close\");\r\n    });\r\n    return true;\r\n  });\r\n\r\n  enableMakeClaimButton();\r\n}\r\nvar createClaim = function(pageName) {\r\n\r\n  $('<input class=\"card-content\" id=\"card_subcards__Source_content\" name=\"card[subcards][+Source][content]\" value=\"' + pageName + '\" type=\"hidden\" />')\r\n    .insertAfter(\"#card_type_id\");\r\n  $_form = $('#claim-form').find('form:first');\r\n  $_form.setContentFieldsFromMap();\r\n  var result = \"\";\r\n  var url = \"/card/create/\";\r\n  $.ajax({\r\n      type: \"POST\",\r\n      url: url,\r\n      data: $_form.serialize()\r\n    })\r\n    .done(function(data) {\r\n      $('#claim-form').empty();\r\n      if (!markedIrrelevant)\r\n        refreshClaimNumber(pageName);\r\n      $('#claim-form').dialog(\"close\");\r\n    }).fail(function() {\r\n\r\n      $_submitButton = $_form.find('.create-submit-button:first');\r\n      $_submitButton.removeAttr(\"disabled\");\r\n      $_submitButton.html(\"Submit\");\r\n\r\n    });\r\n}\r\n\r\n$(document).ready(function() {\r\n\r\n  $(\"#logo-bar\").dblclick(function() {\r\n    return false;\r\n  });\r\n  var url = QueryString.url;\r\n  var company = QueryString.company;\r\n  var topic = QueryString.topic;\r\n\r\n  if (url) {\r\n    testSameOrigin(url);\r\n    decodeUrl = decodeURIComponent(url);\r\n    $iframe = $('<iframe id=\"source-preview-iframe\" src=\"' + decodeURIComponent(url) + '\" sandbox=\"allow-same-origin allow-scripts allow-forms\" >');\r\n    $('#webpage-preview').append($iframe);\r\n  }\r\n  if (company) {\r\n    decodedCompanyName = decodeURIComponent(company);\r\n    $('#company-and-topic').find('.company-name').html(\"<a href='\" + company + \"' target='_blank'><span class='company-name'>\" + decodeURIComponent(company) + \"</span></a>\");\r\n  }\r\n  if (topic) {\r\n    decodedTopicName = decodeURIComponent(topic);\r\n    $('#company-and-topic').find('.topic-name').html(\"<a href='\" + topic + \"' target='_blank'><span class='topic-name'>\" + decodeURIComponent(topic) + \"</span></a>\");\r\n  }\r\n\r\n  $('#mark-irrelevant-button').click(irrelevantClicked);\r\n  $(\"#company-and-topic-detail-link\").click(comapnyAndTopicDetailLinkClicked);\r\n  $(\"#make-a-claim-button\").click(makeClaimButtonOnClicked);\r\n\r\n  if (QueryString.fromcerth && QueryString.fromcerth == 'true') {\r\n    getSourcePageName(checkCompanyAndTopicCombination);\r\n  } else {\r\n    getSourcePageName(showExisitingSourceOptions);\r\n  }\r\n  resizeIframe();\r\n});\r\n\r\n\r\n$(window).resize(function() {\r\n  resizeIframe();\r\n});"
      }
    ]
  }
}